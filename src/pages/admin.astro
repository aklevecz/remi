---
import { desc } from "astro:db";
import PageHeading from "../components/PageHeading.astro";
import Layout from "../layouts/Layout.astro";
import { Image } from "astro:assets";

const R2 = Astro.locals.runtime.env.R2;

if (Astro.request.method === "POST") {
  const form = await Astro.request.formData();
  const title = form.get("title") as string;
  const description = form.get("description");
  const material = form.get("material");
  const image = form.get("image") as File;

  const fileName = title.replace(/\s+/g, "-").toLowerCase();
  // const imageBuffer = await image.arrayBuffer();
  // const imageBase64 = Buffer.from(imageBuffer).toString("base64");
  // console.log(imageBase64);
  await R2.put(`paintings/${fileName}`, image, { contentType: image.type, customMetadata: { title, description, material } });
  return Astro.redirect("/admin");
}

// if (Astro.request.method === "DELETE") {
const url = new URLSearchParams(new URL(Astro.request.url).search);
const key = url.get("key");
const action = url.get("action");
if (action == "del") {
  await R2.delete(key);
  return Astro.redirect("/admin");
}
// }

const paintings = await R2.list();
const env = process.env.NODE_ENV;

const imgHost = env === "production" ? "https://remifrogo.art" : "http://localhost:4321";
---

<Layout title="admin">
  <PageHeading> Admin </PageHeading>
  <div class="container">
    <div class="paintings">
      {
        paintings.objects.map((painting: any) => {
          return (
            <div>
              <>
                <Image
                  width="300"
                  height="300"
                  src={`${imgHost}/img/${painting.key}`}
                  alt={painting.key}
                />
                <h2>{painting.key}</h2>
                <div>{painting.customMetadata.description || "DESC"}</div>
                <div>{painting.customMetadata.material || "MATERIAL"}</div>
                <a href={`/admin?action=del&key=${painting.key}`}>DELETE</a>
              </>
            </div>
          );
        })
      }
    </div>
    <form method="POST" enctype="multipart/form-data">
      <label for="title">Title:</label>
      <input type="text" id="title" name="title" required />

      <label for="description">Description:</label>
      <textarea id="description" name="description" required></textarea>

      <label for="material">Material:</label>
      <input type="text" id="material" name="material" required />

      <label for="image">Image:</label>
      <input type="file" id="image" name="image" accept="image/*" required />

      <button type="submit">Upload</button>
    </form>
  </div>
</Layout>
<script>
  const buttons = document.querySelectorAll("button");
  buttons.forEach((button) => {
    button.addEventListener("click", async (e: any) => {
      const key = e.target.id;
      await fetch(`/admin?key=${key}`, { method: "DELETE" });
    });
  });
</script>

<style>
  .container {
    display: flex;
  }
  .paintings {
    padding: 1rem;
  }
  form {
    display: flex;
    flex-direction: column;
    padding: 1rem;
  }
  a {
    box-sizing: border-box;
    background-color: red;
    color: white;
    font-size: 1.25rem;
  }
</style>
