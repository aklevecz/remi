---
import dbInstance from "../lib/db";
import config from "../lib/config";
import { sendEmail } from "../lib/email";

import TattooForm from "../components/TattooForm.astro";
import Layout from "../layouts/Layout.astro";

import { generateUUID } from "../lib/utils";
import VenmoIcon from "../components/icons/VenmoIcon.astro";
import ZelleIcon from "../components/icons/ZelleIcon.astro";
import InstagramIcon from "../components/icons/instagramIcon.astro";
import PageHeading from "../components/PageHeading.astro";

const info = {
  dayOf:
    "Please come hydated and well fed before the appointment. I would also prefer you not do drugs or drink heavily beforehand. The tattoo may take anywhere from 1-3 hours depending on the size and amount of detail. Plan your day accordingly <3",
  designs:
    "I have flash posted that you can look through on my instagram. If you have a custom request, pls make sure we discuss the idea before your appointment",
  deposit:
    "I ask that you send a $50 deposit to me through zelle (preferred): 714-808-7117 or Venmo: @remifrogo - if sending on venmo, please use an emoji for the description. Deposit goes towards total price of tattoo and is meant to secure your appointment spot. If you cancel the night before or day of, you will need to put down another deposit to reschedule.",
  pricing:
    "I have a minimum of $80. Most flash will be around $80-$250 depending on size and complexity. Custom pricing can be discussed beforehand. Please pay the full amount with either Zelle or cash on the day of the appointment",
};

type Values = {
  name: string;
  pronouns: string;
  instagram: string;
  email: string;
  tattooDescription: string;
  tattooPlacement: string;
  tattooSize: string;
  availability: string;
  miscellaneous: string;
  image: File | null;
};

let values: Values = {
  name: "",
  pronouns: "",
  instagram: "",
  email: "",
  tattooDescription: "",
  tattooPlacement: "",
  tattooSize: "",
  availability: "",
  miscellaneous: "",
  image: null,
};

const errors = [];

if (Astro.request.method === "POST") {
  try {
    const data = await Astro.request.formData();
    values.name = data.get("name") as string;
    values.pronouns = data.get("pronouns") as string;
    values.instagram = data.get("instagram") as string;
    values.email = data.get("email") as string;
    values.tattooDescription = data.get("tattoo-description") as string;
    values.tattooPlacement = data.get("tattoo-placement") as string;
    values.tattooSize = data.get("tattoo-size") as string;
    values.availability = data.get("availability") as string;
    values.miscellaneous = (data.get("miscellaneous") as string) || "";
    values.image = data.get("tattoo-image") as File;

    const {
      name,
      pronouns,
      instagram,
      email,
      tattooDescription,
      tattooPlacement,
      tattooSize,
      availability,
      image,
      miscellaneous,
    } = values;
    if (
      !name ||
      !pronouns ||
      !instagram ||
      !email ||
      !tattooDescription ||
      !tattooPlacement ||
      !tattooSize ||
      !availability ||
      !image ||
      image.size === 0
    ) {
      if (!name) errors.push("Name is required");
      if (!pronouns) errors.push("Pronouns are required");
      if (!instagram) errors.push("Instagram handle is required");
      if (!email) errors.push("Email is required");
      if (!tattooDescription) errors.push("Tattoo description is required");
      if (!tattooPlacement) errors.push("Tattoo placement is required");
      if (!tattooSize) errors.push("Tattoo size is required");
      if (!availability) errors.push("Availability is required");
      if (!image || image.size === 0) errors.push("Image is required");
      console.log(errors);
    } else {
      const R2 = Astro.locals.runtime.env.R2;
      const now = new Date();
      const imgFileName = String(now.getTime());
      await R2.put(imgFileName, image, { contentType: image.type });
      const user = await dbInstance.getUserByEmail(email);
      let userId = null;
      if (user.length > 0) {
        userId = user[0].id;
      } else {
        await dbInstance.createUser({ name, email, instagram });
        const user = await dbInstance.getUserByEmail(email);
        userId = user[0].id;
      }
      const id = generateUUID();
      await dbInstance.createAppointment({
        id,
        userId,
        name,
        email,
        instagram,
        pronouns,
        tattooDescription,
        tattooPlacement,
        tattooSize,
        availability,
        miscellaneous,
        imgFileName,
        now,
      });
      const baseUrl = new URL(Astro.request.url).origin
      await sendEmail({
        email,
        subject: "Your appointment has been scheduled!",
        message:
          `Your appointment has been scheduled! Please reach out to me if you have any questions or need to reschedule.<a href=${baseUrl}/success/${id}>View your appointment info here</a>`,
      });
      await sendEmail({
        email: config.email,
        subject: "New Appointment Request",
        message: `New appointment request from ${name} at ${email}`,
      });
      return Astro.redirect(`/success/${id}`);
    }
  } catch (e) {
    console.log(e);
    errors.push("There was an error processing your request");
  }
}
console.log()
---

<Layout title="Tats">
  <PageHeading>Tattoos</PageHeading>
  <div class="container">
    <div class="content">
      <div class="info-section">
        <h2>BOOKING POLICIES</h2>
        <p>$50 deposit is required to lock in the appointment - the deposit will go toward the cost of the tattoo!</p>
        <div class="flex flex-col gap-4">
          <div class="flex items-center gap-4">
            <VenmoIcon /><a href="https://account.venmo.com/u/remifrogo">@remifrogo</a>
          </div>
          <div class="flex items-center gap-4"><ZelleIcon /> <div>7148087117</div></div>
        </div>
        <p>
          feel free to contact me with any questions through DM <a href={config.remboInstagram}
            ><InstagramIcon />remb0tron</a
          >
          on instagram
          {"<3"}
        </p>
      </div>
      <div>
        <h2>INFO</h2>
        <TattooForm values={values} />
      </div>
    </div>
  </div>
</Layout>
<script>
  const debounce = (func: any, delay = 200) => {
    let timeoutId: any;
    return (...args: any) => {
      clearTimeout(timeoutId);
      timeoutId = setTimeout(() => {
        func.apply(null, args);
      }, delay);
    };
  };

  const handleScroll = () => {
    if (window.innerWidth > 768) return;
    const scrollHeight = window.scrollY;
    const infoSection = document.querySelector(".info-section") as HTMLDivElement;
    const computedHeight = infoSection.getBoundingClientRect().height - scrollHeight;
    if (computedHeight < 100) {
      debounce(() => infoSection.classList.add("small"))();
    } else {
      debounce(() => infoSection.classList.remove("small"))();
    }
  };

  window.addEventListener("scroll", handleScroll);
</script>
<style>
  .container {
    max-width: 1000px;
    margin: auto;
  }
  .content {
    display: flex;
    flex-direction: column;
    justify-content: center;
    gap: 2rem;
    margin-top: 1rem;
  }

  @media (min-width: 768px) {
    .content {
      flex-direction: row;
      /* justify-content: space-between; */
    }
  }
  .info-section {
    max-width: 500px;
    /* margin: auto; */
    position: sticky;
    top: 0;
    align-self: flex-start;
    background: var(--green);
    z-index: 9;
    font-size: 1.5rem;
    transition: font-size 500ms;
  }

  .info-section.small {
    font-size: 1rem;
  }
</style>
